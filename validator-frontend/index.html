<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="./htmx.min.js"></script>
  </head>
  <body>
    <main class="main-content">
      <div class="card-container">
        <div class="card">
          <div class="initialize-section">
            <label>Entre com uma carteira</label>
            <div class="initialize-buttons" id="initializeWallet">
              <button class="initialize-button" id="newWallet">
                Nova Carteira
              </button>
              <button class="initialize-button" id="existingWallet">
                Carteira Existente
              </button>
            </div>
          </div>
        </div>
        <div class="card" id="bottomCard">
          <form id="transactionSelector">
            <div class="upload-section">
              <label for="file-upload">Insira seu arquivo</label>
              <input type="file" id="file-upload" />
              <div class="action-buttons">
                <button class="btn" type="submit" value="verifyHash">
                  Verificar
                </button>
                <button class="btn" type="submit" value="storeHash">
                  Registrar
                </button>
                <button class="btn" type="submit" value="atualizar">
                  Atualizar
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </main>
    <script type="module">
      import {
        populateTransaction,
        signTransaction,
        formatUnits,
        generateHash,
      } from "./transactions.js";
      import {
        randomMnemonicPhrase,
        initializeWallet,
        getWallet,
      } from "./wallet.js";

      document
        .getElementById("initializeWallet")
        .addEventListener("click", async function (event) {
          const button = event.target;

          if (button.id === "newWallet") {
            const mnemonicPhrase = await randomMnemonicPhrase();
            console.log(mnemonicPhrase);

            document.getElementById("initializeWallet").innerHTML = `
            <p>${mnemonicPhrase}</p>
            <button id="continueNewWallet">Continuar</button>
          `;
          } else if (
            button.id === "existingWallet" ||
            button.id === "continueNewWallet"
          ) {
            console.log("Carteira Existente");

            document.getElementById("initializeWallet").innerHTML = `
            <label for="mnemonicPhrase">Mnemonic Phrase</label><br />

            <input type="text" id="mnemonicPhrase" name="mnemonicPhrase" /><br />
            <button id="continueExistingWallet">Continuar</button>
            `;
          } else if (button.id === "continueExistingWallet") {
            const mnemonicPhrase =
              document.getElementById("mnemonicPhrase").value;
            console.log(mnemonicPhrase);

            await initializeWallet(mnemonicPhrase);

            const wallet = await getWallet();

            document.getElementById("initializeWallet").innerHTML = `
            <div class="label-field-section">
                <div class="label-field">
                    <label for="public-key">Sua chave pÃºblica</label>
                    <div class="input-group" id="public-key-input">
                        <input type="text" id="public-key" value=${
                          wallet.signingKey.publicKey
                        } readonly>
                        <button class="copy-btn">ðŸ“‹</button>
                    </div>
                    <label for="public-key">Hash da chave pÃºblica</label>
                    <div class="input-group" id="hash-public-key-input">
                        <input type="text" id="hash-public-key" value=${generateHash(
                          wallet.signingKey.publicKey
                        )} readonly>
                        <button class="copy-btn">ðŸ“‹</button>
                    </div>
                </div>
                <div class="label-field">
                    <label for="address">Seu endereÃ§o</label>
                    <div class="input-group">
                        <input type="text" id="address" value=${
                          wallet.address
                        } readonly>
                        <button class="copy-btn">ðŸ“‹</button>
                    </div>
                </div>
            </div>
          `;
          }
        });

      document.addEventListener("submit", async function (event) {
        if (event.target.id === "transactionSelector") {
          event.preventDefault();

          const clickedButton = event.submitter;
          const wallet = await getWallet();

          console.log("clickedButton", clickedButton.value);

          const contractMethod = clickedButton.value;
          const publicKey = wallet.signingKey.publicKey;
          const documentHash = localStorage.getItem("documentHash");

          if (clickedButton.value === "storeHash") {
            const transaction = await fetch(
              "http://localhost:3000/transactions/build",
              {
                method: "POST",
                body: JSON.stringify({
                  contractMethod: contractMethod,
                  publicKey: publicKey,
                  documentHash: documentHash,
                }),
                headers: {
                  "Content-Type": "application/json",
                },
              }
            ).then((response) => response.json());

            const populatedTransaction = await populateTransaction(transaction);

            const signedTransaction = await signTransaction(
              populatedTransaction
            );

            const element = `
        <form id="transactionBroadcast"
          hx-post="http://localhost:3000/transactions/broadcast"
          hx-swap="outerHTML"
          hx-include="[name='transaction']">

          <div class="label-field-section">
          <label>Registrar Documento</label>
          <div class="label-field">
            <label class="fee-label" for="fee">Taxa</label>
              <div class="row-section">
                <div class="fee-input-group">
                    <input type="text" id="fee" value=${formatUnits(
                      populatedTransaction.maxFeePerGas *
                        populatedTransaction.gasLimit,
                      "gwei"
                    )} readonly>
                    <label for="fee">GWEI</label>
                </div>
                ~
                <div class="fee-input-group">
                    <input type="text" id="fee" value=${formatUnits(
                      populatedTransaction.maxFeePerGas *
                        populatedTransaction.gasLimit,
                      "ether"
                    )} readonly>
                    <label for="fee">ETH</label>
                </div>
              </div>
          </div>
          <div class="label-field-row">
            <input type="checkbox" id="validateDiploma" name="validateDiploma" unchecked />
            <label for="validateDiploma">Verificar Conformidade do Diploma Digital junto ao MEC</label>
          </div>

          <div class="label-field">
            <label for="documentHash">Hash do Documento</label>
            <div class="input-group">
              <input type="text" id="documentHash" name="documentHash" value=${localStorage.getItem(
                "documentHash"
              )} readonly>
              </div>
          </div>


          <input type="hidden" id="transaction" name="transaction" value=${JSON.stringify(
            signedTransaction
          )} />

          <div class="action-buttons">
            <button class="btn" id="return-to-selector">Cancelar</button>
            <button class="btn" type="submit"/>Confirmar</button>
          </div>
        </div>
        </form>
      `;

            document.getElementById("bottomCard").innerHTML = element;
            htmx.process(document.getElementById("transactionBroadcast"));
          }

          if (clickedButton.value === "verifyHash") {
            const element = `
        <form id="verifyHash"
          hx-post="http://localhost:3000/transactions/verify"
          hx-swap="outerHTML"
          hx-include="[name='documentHash']">

          <div class="label-field-section">
          <label>Verificar Documento</label>
          
          

          <div class="label-field">
            <label for="documentHash">Hash do Documento</label>
            <div class="input-group">
              <input type="text" id="documentHash" name="documentHash" value=${localStorage.getItem(
                "documentHash"
              )} readonly>
              </div>
          </div>



          <div class="action-buttons">
            <button class="btn" id="return-to-selector">Cancelar</button>
            <button class="btn" type="submit"/>Confirmar</button>
          </div>
        </div>
        </form>
      `;

            document.getElementById("bottomCard").innerHTML = element;
            htmx.process(document.getElementById("verifyHash"));
          }
        }
      });

      document.addEventListener("click", function (event) {
        if (event.target.id === "return-to-selector") {
          document.getElementById("bottomCard").innerHTML = `
          <form id="transactionSelector">
            
            <div class="upload-section">
              <label for="file-upload">Insira seu arquivo</label>
              <input type="file" id="file-upload" />
              <div class="action-buttons">
                <button class="btn" type="submit" value="verifyHash">
                  Verificar
                </button>
                <button class="btn" type="submit" value="storeHash">
                  Registrar
                </button>
                <button class="btn" type="submit" value="atualizar">
                  Atualizar
                </button>
              </div>
            </div>
          </form>`;
        }
      });

      document.addEventListener("change", async function (event) {
        if (event.target.id === "file-upload") {
          const file = event.target.files[0];
          if (file) {
            const buffer = await fileToBuffer(file);
            const hash = generateHash(buffer);
            console.log("hash", hash);
            localStorage.setItem("documentHash", hash);

            document.getElementById("file-upload").outerHTML = file.name;
          }
        }
      });

      async function fileToBuffer(file) {
        const arrayBuffer = await fileToArrayBuffer(file);
        const byteArray = new Uint8Array(arrayBuffer);

        return byteArray;
      }

      function fileToArrayBuffer(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(reader.error);
          reader.readAsArrayBuffer(file);
        });
      }
    </script>
  </body>
</html>
